name: Blue-Green Deployment

on:
    push:
        branches:
            - main

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        outputs:
            TAG: ${{ steps.set-tag.outputs.TAG }}  # âœ… TAG ê°’ì„ outputìœ¼ë¡œ ì €ì¥
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Set Image Tag
              id: set-tag
              run: echo "TAG=$(echo ${GITHUB_SHA:-latest} | cut -c1-7)" >> $GITHUB_OUTPUT  # âœ… GITHUB_OUTPUTì„ ì‚¬ìš©í•˜ì—¬ outputsì— ì €ì¥

            - name: Debug TAG in build-and-push
              run: echo "TAG=${{ steps.set-tag.outputs.TAG }}"  # âœ… TAG ê°’ í™•ì¸

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to GitHub Container Registry
              run: |
                  echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.REPOSITORY_OWNER }}" --password-stdin
                  docker info | grep "Username"

            - name: Build and push Docker image
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    --push \
                    -t ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:${{ steps.set-tag.outputs.TAG }} \
                    -t ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:latest .

    deploy:
        needs: [build-and-push]
        runs-on: ubuntu-latest
        env:
            TAG: ${{ needs.build-and-push.outputs.TAG }}  # âœ… build-and-pushì˜ TAG ê°’ ê°€ì ¸ì˜¤ê¸°
        steps:
            - name: Debug TAG in deploy
              run: echo "TAG=${{ env.TAG }}"  # âœ… deploy ë‹¨ê³„ì—ì„œ TAGê°€ ì •ìƒì ìœ¼ë¡œ ì˜¤ëŠ”ì§€ í™•ì¸

            - name: Prepare SSH Key
              run: |
                  echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem
                  chmod 600 key.pem

            - name: Login to GitHub Container Registry
              run: |
                  echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.REPOSITORY_OWNER }}" --password-stdin
                  docker info | grep "Username"

            - name: SSH into EC2 and Deploy
              run: |
                  HOST=${{ secrets.EC2_HOST }}
                  USER=${{ secrets.EC2_USER }}
                  TAG=${{ env.TAG }}
                  
                  echo "ğŸ¯ í˜„ì¬ ë°°í¬í•  íƒœê·¸: $TAG"
                  ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST "TAG=$TAG bash -s" << EOF
                    set -e
                  
                    echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸"
                    ACTIVE_CONTAINER=\$(docker ps --format '{{.Names}}' | grep -E 'blue-[12]|green-[12]' | head -n 1 || echo 'blue-1')
                    
                    if [[ "\$ACTIVE_CONTAINER" == "blue-1" || "\$ACTIVE_CONTAINER" == "blue-2" ]]; then
                        NEW_VERSION="green"
                        OLD_VERSION="blue"
                    else
                        NEW_VERSION="blue"
                        OLD_VERSION="green"
                    fi
                
                    echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ: \$ACTIVE_CONTAINER"
                    echo "ğŸ”„ ë‹¤ìŒ ë°°í¬í•  ì»¨í…Œì´ë„ˆ ê·¸ë£¹: \$NEW_VERSION"
                    
                    echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ë°°í¬: \$NEW_VERSION"
                    echo "âœ… ì‚¬ìš©ë˜ëŠ” ì´ë¯¸ì§€ íƒœê·¸: \$TAG"
                    
                    docker pull ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:\$TAG
                  
                    echo "ğŸ’¾ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ"
                    aws ssm get-parameter --name ${{ secrets.PARAMETER_NAME }} --with-decryption --query 'Parameter.Value' --output text > env_file
                  
                    echo "ğŸ“¦ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
                    docker-compose pull \${NEW_VERSION}-1 \${NEW_VERSION}-2
                    docker-compose up -d --no-deps --force-recreate --remove-orphans --build \${NEW_VERSION}-1 \${NEW_VERSION}-2
                    
                    echo "â³ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°..."
                    MAX_RETRIES=30
                    RETRY_INTERVAL=3
                    COUNT=0
                    while ! docker inspect --format='{{.State.Health.Status}}' \${NEW_VERSION}-1 | grep -q 'healthy' || \
                        ! docker inspect --format='{{.State.Health.Status}}' \${NEW_VERSION}-2 | grep -q 'healthy'; do
                        if [ \$COUNT -ge \$MAX_RETRIES ]; then
                            echo "âŒ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ê¸°ë™ë˜ì§€ ì•ŠìŒ! ë¡¤ë°± ì§„í–‰..."
                            docker-compose stop \${NEW_VERSION}-1 \${NEW_VERSION}-2
                            docker-compose rm -f \${NEW_VERSION}-1 \${NEW_VERSION}-2
                            exit 1
                        fi
                        echo "ğŸ”„ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘ (\$COUNT/\$MAX_RETRIES)..."
                        sleep \$RETRY_INTERVAL
                        COUNT=\$((COUNT + 1))
                    done
                    echo "âœ… ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì •ìƒ ê¸°ë™ë¨!"
                    
                    echo "ğŸ“ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (Blue-Green ì „í™˜)"
                    sed -i "s|server \${OLD_VERSION}-1:8181;|server \${NEW_VERSION}-1:8181;|" ./nginx/nginx.conf
                    sed -i "s|server \${OLD_VERSION}-2:8181;|server \${NEW_VERSION}-2:8181;|" ./nginx/nginx.conf
                    
                    echo "ğŸ”„ Nginx ì„¤ì • ë°˜ì˜ (í—¬ìŠ¤ì²´í¬ ì„±ê³µ í›„ Reload)"
                    docker exec nginx-proxy nginx -s reload
                    
                    echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì •ë¦¬"
                    docker-compose stop \${OLD_VERSION}-1 \${OLD_VERSION}-2
                    docker-compose rm -f \${OLD_VERSION}-1 \${OLD_VERSION}-2
                    rm -f env_file
                  
                    echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
                  EOF

            - name: Clean up SSH Key
              run: rm -f key.pem