name: Blue-Green Deployment

on:
    push:

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Set Image Tag
              run: echo "TAG=$(echo ${GITHUB_SHA:-latest} | cut -c1-7)" >> $GITHUB_ENV

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Debug Environment Variables
              run: echo "TAG=${{ env.TAG }}"  # âœ… TAG ê°’ í™•ì¸

            - name: Login to GitHub Container Registry
              run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.REPOSITORY_OWNER }}" --password-stdin

            - name: Build and push Docker image
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    --push \
                    -t ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:${{ env.TAG }} \
                    -t ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:latest .

    deploy:
        needs: [build-and-push]
        runs-on: ubuntu-latest
        steps:
            - name: Prepare SSH Key
              run: |
                  echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem
                  chmod 600 key.pem

            - name: SSH into EC2 and Deploy
              run: |
                  HOST=${{ secrets.EC2_HOST }}
                  USER=${{ secrets.EC2_USER }}

                  ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST << 'EOF'
                    set -e

                    echo "ðŸ” í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸"
                    ACTIVE_CONTAINER=$(docker ps --format '{{.Names}}' | grep -E 'blue|green' || echo 'blue')

                    if [ "$ACTIVE_CONTAINER" == "blue" ]; then
                      NEW_VERSION="green"
                      OLD_VERSION="blue"
                    else
                      NEW_VERSION="blue"
                      OLD_VERSION="green"
                    fi

                    echo "ðŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ë°°í¬: $NEW_VERSION"

                    TAG=${{ env.TAG }}  # âœ… TAG ê°’ì„ ëª…í™•ížˆ ì„¤ì •

                    echo "íƒœê·¸ëŠ” ? $TAG"
                    echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.REPOSITORY_OWNER }}" --password-stdin
                    docker pull ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:$TAG  # âœ… TAGë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©
    EOF

- name: Clean up SSH Key
  run: rm -f key.pem