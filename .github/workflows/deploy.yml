name: Blue-Green Deployment

on:
    push:

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Set Image Tag
              run: echo "TAG=$(echo ${GITHUB_SHA:-latest} | cut -c1-7)" >> $GITHUB_ENV

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Debug Environment Variables
              run: echo "TAG=${{ env.TAG }}"  # âœ… TAG ê°’ í™•ì¸

            - name: Login to GitHub Container Registry
              run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.REPOSITORY_OWNER }}" --password-stdin

            - name: Build and push Docker image
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    --push \
                    -t ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:${{ env.TAG }} \
                    -t ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:latest .

    deploy:
        needs: [build-and-push]
        runs-on: ubuntu-latest
        steps:
            - name: Prepare SSH Key
              run: |
                  echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem
                  chmod 600 key.pem

            - name: SSH into EC2 and Deploy
              run: |
                  HOST=${{ secrets.EC2_HOST }}
                  USER=${{ secrets.EC2_USER }}
                  TAG=${{ env.TAG }}  # âœ… GitHub Actionsì—ì„œ í™˜ê²½ ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°

                  ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST << EOF
                    set -e

                    echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸"
                    ACTIVE_CONTAINER=\$(docker ps --format '{{.Names}}' | grep -E 'blue|green' || echo 'blue')

                    if [ "\$ACTIVE_CONTAINER" == "blue" ]; then
                      NEW_VERSION="green"
                      OLD_VERSION="blue"
                    else
                      NEW_VERSION="blue"
                      OLD_VERSION="green"
                    fi

                    echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ë°°í¬: \$NEW_VERSION"
                    echo "âœ… ì‚¬ìš©ë˜ëŠ” ì´ë¯¸ì§€ íƒœê·¸: $TAG"

                    echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.REPOSITORY_OWNER }}" --password-stdin
                    docker pull ghcr.io/${{ secrets.REPOSITORY_OWNER }}/community-server:$TAG

                    echo "ğŸ’¾ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ"
                    aws ssm get-parameter --name ${{ secrets.PARAMETER_NAME }} --with-decryption --query 'Parameter.Value' --output text > env_file

                    echo "ğŸ“¦ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
                    docker-compose up -d --no-deps --force-recreate --remove-orphans --build \$NEW_VERSION
                    rm -f env_file

                    echo "â³ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°..."
                    MAX_RETRIES=30
                    RETRY_INTERVAL=3
                    COUNT=0
                    while ! docker inspect --format='{{.State.Health.Status}}' \$NEW_VERSION | grep -q 'healthy'; do
                        if [ \$COUNT -ge \$MAX_RETRIES ]; then
                            echo "âŒ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ê¸°ë™ë˜ì§€ ì•ŠìŒ! ë¡¤ë°± ì§„í–‰..."
                            docker-compose stop \$NEW_VERSION
                            docker-compose rm -f \$NEW_VERSION
                            exit 1
                        fi
                        echo "ğŸ”„ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘ (\$COUNT/\$MAX_RETRIES)..."
                        sleep \$RETRY_INTERVAL
                        COUNT=\$((COUNT + 1))
                    done
                    echo "âœ… ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì •ìƒ ê¸°ë™ë¨!"

                    echo "ğŸ“ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (Blue-Green ì „í™˜)"
                    sed -i "s/server \$OLD_VERSION:8181;/server \$NEW_VERSION:8181;/" /home/user/deployment/nginx.conf
                    docker exec -it nginx-proxy nginx -s reload

                    echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì •ë¦¬"
                    docker-compose stop \$OLD_VERSION && docker-compose rm -f \$OLD_VERSION

                    echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
                  EOF

            - name: Clean up SSH Key
              run: rm -f key.pem